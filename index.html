<!DOCTYPE html>
<html>








  
    <link rel="stylesheet" href="/css/bundle.min.a813ac38ae19665d1783b4afe356b7336e3ad179018db2713a2b31f1f3992006.css" integrity="sha256-qBOsOK4ZZl0Xg7Sv41a3M2460XkBjbJxOisx8fOZIAY=" crossorigin="anonymous">
  







  
  <script type="text/javascript" src="/js/app.6d39b5db662b8b2a61f3ac822fcfadfd7ec60d51a12cfab9313f20ba78f5d81e.js" integrity="sha256-bTm122Yriyph86yCL8&#43;t/X7GDVGhLPq5MT8gunj12B4=" crossorigin="anonymous" defer></script>
  
  


<link rel="stylesheet" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"/>
<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script><body><div id="content">
<section class="mw6 center">

<nav>
  

    <div class="db dtc-ns v-mid tl w-50">
      <a href="/" class="dib avenir link blog-title">Dqfort&#39;s blog</a>

      <div class="dib">
        <small class="avenir f7 black-70 fw2">
          satisfy or build better.
        </small>
      </div>
  
</nav>




  <article class="ph4-ns pv5-ns">
    
    <h1 class="f4 fw6 blog-heading">Querying in Prometheus</h1>
    
    <time class="f6 db gray avenir">2020-06-02</time>
    <div class="f6 black-70 avenir lh-copy">
      <p>By using <a href="https://prometheus.io/">prometheus</a>, server monitoring becomes much easier.
Prometheus cannot provide any server system information, which need to collect from <a href="https://prometheus.io/docs/guides/node-exporter/">node explorer</a> or <a href="https://github.com/google/cadvisor">cadvisor</a>.</p>
<p>So what is promethus for? one of the features is querying by
<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a>, to generate more meaningful information.</p>
<p>For example, if we want to know CPU usage of containers,
we can use:</p>
<pre><code>rate(container_cpu_seconds_total[5m]) * 100
</code></pre><p>container_cpu_seconds_total is how many seconds of CPU used in a container, rate is a function to take average value in range, 5m means 5 minutes and * 100 to convert to percentage.</p>
<p>If we get two servers with same configaration and we want to see the avarage CPU usages, it can be querying by:</p>
<pre><code>(sum by (name) (rate(container_cpu_seconds_total[5m]) * 100))
/(count by (name) (container_cpu_seconds_total))
</code></pre><p>using sum by name to get the values group by name, and count by name to get the count of containers, then the result is average of two servers CPU usage.</p>

    </div>
  </article>

  <article class="ph4-ns pv5-ns">
    
    <h1 class="f4 fw6 blog-heading">Simple Ways to Split Large List into Celery</h1>
    
    <time class="f6 db gray avenir">2020-05-24</time>
    <div class="f6 black-70 avenir lh-copy">
      <p>When getting a large list of records from database it causes
that task running very slow in <a href="https://docs.celeryproject.org/">Celery</a>. Celery is a task worker
that usually to handle time consume job in daemon.</p>
<p>Let say we get 2000+ records in a database table posts, a simple way
to split that just limit the records from the query</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># using django ORM syntax, get 100 records each time</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">100</span><span class="p">]</span>
<span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
   <span class="n">handle_post</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
</code></pre></div><p>Even more we can randomly get from first or end</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># to get the records from first or end, not just stacked on first</span>
<span class="n">sort</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span> <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;-id&#39;</span>

<span class="c1"># using django ORM syntax, get 100 records each time</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sort</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span>
<span class="c1"># ...</span>
</code></pre></div><p>It would make task loading more balance.</p>

    </div>
  </article>

  <article class="ph4-ns pv5-ns">
    
    <h1 class="f4 fw6 blog-heading">1/2 = 1 - 1 &#43; 1 - 1 &#43; 1 ...</h1>
    
    <time class="f6 db gray avenir">2020-05-21</time>
    <div class="f6 black-70 avenir lh-copy">
      <p>There is a mathematics question:
$$1 - 1 + 1 - 1 + 1 &hellip;$$ for infinitely
you might know the answer is 1/2 by a simple proof:
$$\text{Let}\ S = 1 - 1 + 1 - 1 &hellip;$$
$$S = 1 - (1 - 1 + 1 - 1 &hellip;)$$
$$S = 1 - S$$
$$S = \frac 1 2$$</p>
<p>The result seems quite not make sense since when you calculate that step by step,
it always return 0 or 1.
So how is it possible? let&rsquo;s try to reverse the answers:
$$\frac 1 2 = (1-\frac 1 2) = (1 - (1 - \frac 1 2)) = (1 - (1 - (1 - \frac 1 2))) = (1 - (1 - (1 - (1 - &hellip;)))) = 1 - 1 + 1 - 1 &hellip;$$</p>
<p>It does make sense, but why we cannot calculate 1 - 1 + 1 - 1 &hellip; directly?
It&rsquo;s because it was calculated step by step and will never be infinite!</p>
<p>I also write a simple script of it
<a href="https://stackblitz.com/edit/half-infinty">https://stackblitz.com/edit/half-infinty</a></p>

    </div>
  </article>

  <article class="ph4-ns pv5-ns">
    
    <h1 class="f4 fw6 blog-heading">Build Autocomplete With Angular Material</h1>
    
    <time class="f6 db gray avenir">2020-03-07</time>
    <div class="f6 black-70 avenir lh-copy">
      <p><a href="https://material.angular.io/">Angular Material</a> provides rich UI controls, such as Autocomplete, is very a general UI control for finding a value from a long dataset. In this article we explore how to build an Autocomplete control connected with HTTP service, here is a <a href="https://stackblitz.com/edit/http-autocomplete">complete example</a>.</p>
<p>Install Angular Materail is very easy, just follow the <a href="https://material.angular.io/guide/getting-started">Getting started</a> from the guides.
After the installation import the autocomplete control in app module</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span><span class="nx">MatAutocompleteModule</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@angular/material/autocomplete&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">MatInputModule</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@angular/material/input&#39;</span><span class="p">;</span>

<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">MatAutocompleteModule</span><span class="p">,</span>
    <span class="nx">MatInputModule</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">})</span>
</code></pre></div><p>You can check the import statement from <a href="https://material.angular.io/components/autocomplete/api">API reference</a>, <code>MatInputModule</code> is also requried for this example</p>
<p>To display <code>Autocomplete</code>, add the HTML code</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">mat-form-field</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span>
           <span class="na">placeholder</span><span class="o">=</span><span class="s">&#34;Pick one&#34;</span>
           <span class="na">matInput</span>
           <span class="err">[</span><span class="na">formControl</span><span class="err">]=&#34;</span><span class="na">myControl</span><span class="err">&#34;</span>
           <span class="err">[</span><span class="na">matAutocomplete</span><span class="err">]=&#34;</span><span class="na">auto</span><span class="err">&#34;</span>
    <span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">mat-autocomplete</span> <span class="err">#</span><span class="na">auto</span><span class="o">=</span><span class="s">&#34;matAutocomplete&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">mat-option</span> <span class="err">*</span><span class="na">ngFor</span><span class="o">=</span><span class="s">&#34;let option of filteredOptions | async&#34;</span> <span class="err">[</span><span class="na">value</span><span class="err">]=&#34;</span><span class="na">option</span><span class="err">.</span><span class="na">id</span><span class="err">&#34;</span><span class="p">&gt;</span>
        {{option.name}}
      <span class="p">&lt;/</span><span class="nt">mat-option</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">mat-autocomplete</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">mat-form-field</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div><p>The input text is binding <code>myControl</code> and mat-option is listing <code>filteredOptions</code> which defined in the Compenent</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">@Component</span><span class="p">({</span>
  <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;my-app&#39;</span><span class="p">,</span>
  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;./app.component.html&#39;</span><span class="p">,</span>
  <span class="nx">styleUrls</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;./app.component.css&#39;</span> <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span>  <span class="p">{</span>
  <span class="nx">myControl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="nx">filteredOptions</span>: <span class="kt">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>It didn&rsquo;t get any action yet, let&rsquo;s make it listing options when input changes</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">ngOnInit() {</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">filteredOptions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">myControl</span><span class="p">.</span><span class="nx">valueChanges</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">startWith</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="nx">switchMap</span><span class="p">(</span><span class="nx">lookupVal</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lookUp</span><span class="p">(</span><span class="nx">lookupVal</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="nx">lookUp</span><span class="p">(</span><span class="nx">lookupVal</span><span class="p">)</span><span class="o">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">listUrl</span> <span class="o">=</span> <span class="s1">&#39;api/heroes&#39;</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">findUrl</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">listUrl</span><span class="si">}</span><span class="sb">?name=</span><span class="si">${</span><span class="nx">lookupVal</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">listUrl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">lookupVal</span><span class="p">)</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">findUrl</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="o">&lt;</span><span class="nx">any</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>the url &lsquo;api/heroes&rsquo; is getting data from a simple http service <a href="https://github.com/angular/in-memory-web-api">in memory web api</a> provides simple CRUD operations. So what happened from above code? Actually it&rsquo;s using <a href="https://rxjs.dev">RxJS</a> library to handle interaction between the form control and filtered options. <code>RxJS</code> is very powerful to handle async data. In above example, <code>valueChanges</code> is returning what you typed in the input text, the <code>pipe</code> method is modifying your inputted text to <code>lookUp</code> method return values, which means when you typed it will make a http call and return the results to Autocomplete options.</p>
<p>Other parts of the code are about the issues such as display correct value in input text,
handle tab key/focus out events. It done in hacky ways, it&rsquo;d better to extend the class to create a custom control.</p>

    </div>
  </article>

</section>


<div class="scrollbar-container">
  <div class="scrollbar">
    <div class="scrollarea">
      <div class="padding"></div>
      <div class="scroller">
        <div class="handle"></div>
      </div>
      <div class="padding"></div>
    </div>
  </div>
</div>

        </div>
        <div id="footer"><div class="mw6 center pa2 footer-wrap">
  <div class="flex items-center justify-end">

    <small class="ph2-ns">Power by <a href="https://gohugo.io/" class="link underline gray hover-blue">Hugo</a></small>

    <a class="link h1 w1 rss" href="index.xml" title="">
      <svg data-icon="rss" viewBox="0 0 32 32" style="fill:currentcolor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-12.832 20c-1.197 0-2.168-.969-2.168-2.165s.971-2.165 2.168-2.165 2.167.969 2.167 2.165-.97 2.165-2.167 2.165zm5.18 0c-.041-4.029-3.314-7.298-7.348-7.339v-3.207c5.814.041 10.518 4.739 10.561 10.546h-3.213zm5.441 0c-.021-7.063-5.736-12.761-12.789-12.792v-3.208c8.83.031 15.98 7.179 16 16h-3.211z"/></svg>
    </a>
  </div>
</div>
</div>
    </body>
</html>
